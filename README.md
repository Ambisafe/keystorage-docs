# Keystorage Service

simple API to store and retrieve keys.

## Features

- open standard storage format used: https://github.com/ethereum/wiki/wiki/Web3-Secret-Storage-Definition
- no authentication, UUID v4 generated by client used as secret key
- rate-limiting used to prevent brute-force attacks

## Usage

persist newly generated key:
```
Header: Authorization: Bearer <jwt token described in billing integration and security>
POST /api/v0/keystore/<uuid v4>

{
  "<according to secret storage definition>"
}

returns:
http 201 - created
http 400 - uuid in json does not match uuid in url / no address contained
http 401 - storageToken not valid
http 409 - conflict
```

retrieve key:
```
GET /api/v0/keystore/<uuid v4>

returns:
http 200 - ok
http 403 - banned
http 404 - not found
```

example:
```
GET /api/v0/keystore/3198bc9c-6672-5ab3-d995-4942343ae5b6

returns:
http 200
{
    "crypto" : {
        "cipher" : "aes-128-ctr",
        "cipherparams" : {
            "iv" : "6087dab2f9fdbbfaddc31a909735c1e6"
        },
        "ciphertext" : "5318b4d5bcd28de64ee5559e671353e16f075ecae9f99c7a79a38af5f869aa46",
        "kdf" : "pbkdf2",
        "kdfparams" : {
            "c" : 262144,
            "dklen" : 32,
            "prf" : "hmac-sha256",
            "salt" : "ae3cd4e7013836a3df6bd7241b12db061dbe2c6785853cce422d148a624ce0bd"
        },
        "mac" : "517ead924a9d0dc3124507e3393d175ce3ff7c1e96529c6c555ce9e51205e9b2"
    },
    "address" : "0xe6b032b23bc145ed19e23792e2a107d0794fe65a",
    "id" : "3198bc9c-6672-5ab3-d995-4942343ae5b6",
    "version" : 3
}
```

## Billing integration

Tenants are charged for operations using [JOSE](https://datatracker.ietf.org/wg/jose/charter/). Following steps necessary:

1. validate that token valid
2. execute operation - create dataset
3. claim JTI as spent

[JWT](https://tools.ietf.org/html/draft-ietf-oauth-json-web-token-32) is used to delegate authorization to resources from tenant to users. The following fields should be used to create the payload:

```
{
  "iss": "tenant",
  "sub": "storage/faucet/recovery",
  "jti": "1234",
  "aud": "ambisafe",
  “exp”: 1426420800,
}
```
The audience of the token is always Ambisafe. The subject is which of the services is consumed. JWT ID claim provides a unique identifier to be used once in exchange for some service.

[JWS](https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41) is used to sign the JWT with tenant's secret key.

```
{
  "alg": "HS256",
  "typ": "JWT"
}
```
The token is created as in the [specification](https://jwt.io) and attached under the `Authorization: Bearer <jwt token described in security>` header.

Once the service is delivered, 

```
Header: Authorization: Bearer <jwt token described previously>
POST oauth.ambisafe.co/api/v0/oauth/consume/<jti>

{
  "jti": "<jit>"
}

returns:
http 200 - consumed
http 404 - not found
```


## Security 


### For GET:

Rate-limiting used to prevent brute-force attacks on GET operation. Any IP that produced 3 x 404 should be banned for 10 minutes.
